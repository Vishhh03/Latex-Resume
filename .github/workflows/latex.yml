name: Build Resume PDF

on:
  push:
    branches:
      - main
    paths:
      - '**.tex'
      - '.github/workflows/latex.yml'

permissions:
  contents: write

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Prevent runaway jobs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:

          fetch-depth: 1

      # Cache Tectonic packages
      - name: Cache Tectonic
        uses: actions/cache@v4
        with:
          path: ~/.cache/Tectonic
          key: tectonic-${{ runner.os }}-${{ hashFiles('resume.tex') }}
          restore-keys: |
            tectonic-${{ runner.os }}-

      # Install FUSE (Required for Tectonic AppImage)
      - name: Install libfuse2
        run: sudo apt-get install -y libfuse2

      # Setup Tectonic (Faster LaTeX Compiler)
      - name: Setup Tectonic
        uses: wtfjoke/setup-tectonic@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build PDF
        run: tectonic resume.tex

      # Push PDF to orphan branch for inline preview
      - name: Push PDF to pdf-output branch
        run: |
          cp resume.pdf /tmp/resume.pdf
          git checkout --orphan pdf-output-temp
          git rm -rf .
          cp /tmp/resume.pdf resume.pdf
          git add resume.pdf
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -m "Update resume PDF"
          git push origin pdf-output-temp:pdf-output --force

      # Also create release for download
      - name: Create Release with PDF
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Resume
          files: /tmp/resume.pdf
          body: "Preview: https://github.com/${{ github.repository }}/blob/pdf-output/resume.pdf"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}